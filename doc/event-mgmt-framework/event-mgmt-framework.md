# Feature Name
Event Management Framework
# High Level Design Document
#### Rev 0.1

# Table of Contents
  * [Revision](#revision)
  * [About This Manual](#about-this-manual)
  * [Scope](#scope)
  * [Definition/Abbreviation](#definitionabbreviation)


# Revision
| Rev |     Date    |       Author       | Change Description                                       |
|:---:|:-----------:|:------------------:|-----------------------------------                       |
| 0.1 | 01/04/2021  | Srinadh Penugonda  | Initial Version                                          |
| 0.2 | 02/09/2021  | Srinadh Penugonda  | Updated with comments from HLD review                    |

# About this Manual
This document provides general information about the implementation of Event Management Framework and functionality supported in phase-1 in SONiC
# Scope
This document describes the high-level design of Event Management Framework feature. 

# 1 Feature Overview

The Event Management Framework feature provides a centralized framework for applications in SONiC network operating system to raise “events” and store them for NBIs to consume. Events are means to indicate a change in the state of the system that operator may be interested in.
Another widely used term for events is "alert" which can be used interchangeably.

There are two types of events: stateful and stateless. Stateful events are also called as alarms. 

*  Stateful Events (Alarms)

   Stateful events, as the name indicates, have a state: RAISED, CLEARED or ACKNOWLEDGED.
   Out of memory, temperature crossing a threshold, and so on, are examples of conditions when the stateful events are triggered.
   Such conditions are dynamic: a faulty software/hardware component encounters the above such condition and **may** come out of that situation when the condition is resolved.
   
   An application *raises* an alarm when it encounters such a faulty condition.
   After the application recovers from the condition, that alarm is *cleared*.
   An operator could *acknowledge* an alarm. This indicates that the user is aware of the faulty condition. 
   
   Overall system health and system LED state is deduced from the severities of alarms.
   An acknowledged alarm is taken out of consideration from deciding system health and system LED is updated accordingly.

   Some alarms go directly from active to cleared state and require little-to-no administrative effort.
   Operator must acknowledge or investigate alarms with a high severity.

*  Stateless Events

   Stateless events, as the name indicates, doesnt have a state. Stateless events are "one shot" notifications to indicate an abnormal/important situation. 
   
   User logging in, authentication failure, configuration changed notification are all examples of stateless events.

Both stateful and stateless events get recorded in the DB. 

1.  Event History Table

    Both stateful and stateless events get recorded in the table, by name "EVENT". EVENT table contains history of all events generated by the system.
    THis table is persisted across system restarts of any kind, including restore to factory defaults and SW upgrades and downgrades.

2. Current Alarm Table

   All raised stateful events - alarms - get recorded in a table, by name, "ALARM". When a component that raised the alarm clears it, the alarm record is removed from ALARM table.
   An user acknowledging a particular alarm will NOT remove that alarm record from this table.
   
   In effect, ALARM table contains outstanding alarms that need to be cleared by those components who raised them.
   This table is NOT persisted and its contents are cleared with a reload.
   
In summary, the framework provides both current and historical event status of software and physical entities of the system through ALARM and EVENT tables. 

Each event has an important characteristic: severity. It indicates how important the condition that raised the event is.
Enterprise SONiC defines following severities for events.

- CRITICAL : A critical condition exists and requires immediate action. A critical event may trigger if one or more hardware components fail, or one or more hardware components exceed temperature thresholds.
- WARNING : A warning condition was observed, but it may or may not result in an error condition.
- INFORMATIONAL : An informational event had occurred, but it does not impact performance.

By default every event will have a severity assigned by the component. The framework provides Event Severity Profiles to customize severity of an event and also can disable an event.
Operator can decide to lower or increase severity of an event or can decide to turn off an event.

An example of event severity profile is as below:
```
{
    "events": [
        {
        	name: "CAM_FULL_ERROR",
        	severity: "WARNING",
        	enable: "true"
        },
        {
        	name: "TEMPERATURE_EXCEEDED",
        	severity: "CRITICAL",
        	enable: "true"
        },
        {
        	name: "PORT_OPSTATUS_ERROR",
        	severity: "INFORMATIONAL",
        	enable: "true"
        }
    ]
}
```
In addition to the above severities, operator can also chose MAJOR or MINOR severities in a severity profile for compatibility with legacy applications.

- MAJOR : A major error had occurred and requires escalation or notification. For example, a major alarm may trigger if an interface failure occurs, such as a port channel being down.
- MINOR : A minor error or noncritical condition occurred that, if left unchecked, might cause system service interruption or performance degradation. A minor alarm requires monitoring or maintenance.

Operator can download default severity profile to a remote host. 
This downloaded file can be modified by changing the severity of a particular event or change the enable/disable flag.
This modified file can then be uploaded to the device.
Operator can select any of these custom severity profiles to change default properties of events.
The selected severity profile will be taken into effect after restarting eventd container.
The selected profile is persistent across reboots and will be in effect until operator selects either default or another custom severity profile and restarts eventd container.

In addition to storing in DB, framework forwards log messages corresponding to raised events to syslog. Framework is flexible enough to customize log messages per each vendor. 

gNMI clients can subscribe to receive events as they are raised. Subscribing through REST will be supported after phase-1.

REST/gNMI clients can query either table with filters - based on severity, delta based on timestamp, sequence-id etc.,

## 1.1 Requirements


### 1.1.1 Functional Requirements

| ID    | Requirement                                            		                  | Comment             |
| :---  | :----                                                 		                  | :---                |
| 1     | Provide API via library for apps to publish events (statless events)            |                     |
| 2     | Provide API via library for apps to publish alarms (stateful events) |                | 
| 3     | Event Infra to write formatted syslog messages corresponding to all events to Syslog. |                    |
| 4     | Event Infra to persist all events and alarms in StateDB.                        |                     |
| 5     | Event Infra to read Event profile ( severity and enable/disable flag ) from a json file. |                    |
| 6     | Event Infra to read Event table parameters (size and # of days) from a config file. |                     |
| 7     | NBI interface (gNMI and REST) and CLI                                           |                     |
| 7.1   | Events                                                        	              |                     |
| 7.1.1 | Openconfig interface to pull event information.                                 |                     |
| 7.1.2 | Openconfig interface to pull event summary information.                         |                     |
|       | Event summary information to contain cumulative counters for:                   |                     |
|       | - Raised-count (events)                                                         |                     |
| 7.1.3 | Openconfig interface to pull events using following filters                     |                     |
|       | - ALL ( pull all events)                                                        |                     |
|       | - Severity.                                                                     |                     |
|       | - Recent records (eg., last 5 minutes, one hour, one day).                      |                     |
|       | - Records between two timestamps,  one timestamp and end, and beginning and a timestamp. |                    |
|       | - All records between two Sequence Numbers (incl begin and end)                 |                     |
| 7.2   | Alarms                                                        	              |                     |
| 7.2.1 | Openconfig interface to pull alarm information.                                 |                     |
| 7.2.2 | Openconfig interface to pull alarm summary information.                         |                     |
|       | Alarms summary information                                                      |                     |
|       | - Total-count (active alarms)                                                   |                     |
|       | - Critical-count                                                                |                     |
|       | - Major-count                                                                   |                     |
|       | - Minor-count                                                                   |                     |
|       | - Warning-count                                                                 |                     |
|       | - Acknowledged-count                                                            |                     |
|       | - Informational-count                                                           |                     |
| 7.2.3 | Openconfig interface to pull alarms using following filters                     |                     |
|       | - ALL ( pull all alarms)                                                        |                     |
|       | - Severity.                                                                     |                     |
|       | - Recent alarms (eg., last 5 minutes, one hour, one day).                       |                     |
|       | - Records between two timestamps, one timestamp and end, and beginning and a timestamp. |                     |
|       | - All records between two Sequence Numbers (incl end and begin)                 |                     |
| 7.2.4 | Openconfig interface  to acknowledge an alarm.                                  |                     |
| 8     | CLI commands                                                                    |                     |
| 8.1   | show alarm [ detail \| summary \| severity \| timestamp <from> <to> \| recent <5min\|1hr\|1day> \| sequence-number <from> <to> \| all]          |                    |
| 8.2   | show event [ detail \| summary \| severity \| timestamp <from> <to> \| recent <5min\|1hr\|1day> \| sequence-number <from> <to>]                 |                     |
| 8.3   | show event severity-profile                                                     |                     |
| 8.4   | alarm acknowledge <sequence id>                                                 |                     |
| 8.5   | logging server <ip> [ log \| event ]                                             | default is 'log'   |
| 8.6   | severity-profile   [ default \| name-of-file ]	                                  |                     |
| 9     | SYSLOG                                                                          |                     |
| 9.1   | Configure message type to be forwarded to server. Message type is log, event or both. Default is both.|                       |
| 10    | Infra for vendor customized LogHandler.                                         |                     |
| 11    | gNMI subscription                                                               |                     |
| 11.1  | Subscribe to openconfig Event container and Alarm container. All events and alarms published to gNMI subscribed clients. |                    |
| 12    | Clear all events (Best effort)                                                  |                     |

### 1.1.3 Scalability Requirements

EVENT table should support 80k/30-day records. Considering the average size of an event to be 400 bytes, the total memory footprint of event history is ~4MB. Current active alarms are limited to total instances of unique alarms (which makes Current Alarm Table is a finite quantity)

## 1.2 Design Overview

![Block Diagram](event-mgmt-uml.JPG)

### 1.2.1 Basic Approach
The feature involves new development. 
Openconfig yang for event table will be one of the deliveries of this feature.
Applications act as producers by writing to a table in redis state-db. 
Redis informs event consumer in eventd whenever there is new record.
Event consumer removes the record and processes it.
It then saves the processed entry in event history table; if the event is an alarm, record gets added to alarm table and system LED is updated. 
Both EVENT and ALARM tables are stored under state-db.
Event consumer then informs log handler(s) to format the log message and send the message to syslog.
Adhoc vendor custom attributes to augment native event attributes will be declared in either as a static map in the code or as a hidden read-only file for phase-1.

### 1.2.2 Container
A new container by name, eventd, is created to hold event consumer logic.

### 1.2.3 SAI Overview
N/A

# 2 Functionality
## 2.1 Target Deployment Use Cases

The framework provides the following key management services:

- Push model: Event/Alarm information to remote syslog hosts and subscribed gNMI clients
- Pull model: Event/Alarm information from CLI, REST/gNMI interfaces
- Ability to change severity of events, ability to turn off a particular event
- Ability to send only events or only general log messages to specific syslog host

## 2.2 Functional Description
Event Management Framework allows applications to store "state" of the system for user to query through various north bound interfaces.

# 3 Design
## 3.1 Overview
There are three players in the event framework. Applications, which raises events; 
an Event consumer to receive updates whenever an application raises an event and 
a set of event receivers for each NBI type.

Applications act as producers of events. Event consumer in eventd container is
informed by redis whenever a new event is produced. Event consumer manages received events,
updates event history table and current alarm table and invokes log handler.
Log handlers constructs messages and sends it over to syslog. 

Operator can chose to change properties of events with the help of event severity profile. Default
event profile is stored at /etc/sonic/default_profile.json. User can download the default severity profile,
modify and upload it back to the switch to apply it. 

Through severity profile, user can change severity of any event and also can enable/disable a 
event.

Through CLI, event history table and current alarm table can be parsed and displayed with various
filters.

### 3.1.1 Event Producers ( Applications )
Application that need to raise an event, need to use event notifiy API ( LOG_EVENT / LOG_ALARM ). 
This API is part of libeventnotify library that applications need to include.
API for python/go applications will be introduced in phase-2.

For stateless event, applications need to provide dynamic message along with event-id ( name of the event ). 
For stateful events, applications need to provide event state ( raise/clear ) and source along with dynamic message and event-id.
The eventd maintains a static map of event-ids. Developers of events need to declare event-id
of new events and other characteristics - like severity and static message that gets appended with dynamic message.

The format of event notify API is:

For stateless events: 
definition: 
```
    LOG_EVENT(name, source, MSG, ...)
```
Usage:
```
    LOG_EVENT(PORT_MTU_UPDATE, alias.c_str(), "Configure  ethernet %s MTU to %s", alias.c_str(), mtu.c_str());
```

For stateful events:
definition:
```
    LOG_ALARM(name, source, action, MSG, ...)
```
Here, action is either RAISE_ALARM or CLEAR_ALARM

Usage:
```
    if (temperature >= THRESHOLD) {
        LOG_ALARM(TEMPERATURE_EXCEEDED, sensor_name_p, RAISE_ALARM, "Temperature for sensor %s is %d degrees", sensor_name_p, current_temp);
    } else {
        LOG_ALARM(TEMPERATURE_EXCEEDED, sensor_name_p, CLEAR_ALARM, "Temperature for the sensor %s is %d degrees ", sensor_name_p, current_temp);
    }
```
#### 3.1.1.2 Development Process

Here is a typical developement process to add/raise new event:

a. Update buildimage/rules/<app>.mk

   Add $(LIBEVENTNOTIFY_DEV) to compile dependency.
   
   Add $(LIBEVENTNOTIFY) to runtime dependency.

```
   Ex: For rules/tam.mk,

       $(SONIC_TAM)_DEPENDS += $(LIBEVENTNOTIFY_DEV)
       $(SONIC_TAM)_RDEPENDS += $(LIBEVENTNOTIFY)
```

b. Update Makefile.am of the app to link to event notify library.
```
   Ex: To let tammgr use event notify API, update src/sonic-tam/tammgr/Makefile.am as below:

       tammgrd_LDADD += -leventnotify
```
c. Declare the new event-id in static_event_table map defined in src/sonic-eventd/lib/src/eventstaticmap.h 

d. In the source file where event is to be raised, include eventnotify.h and invoke LOG_EVENT or LOG_ALARM.

The event notifier takes the event properties, packs a field value tuple and writes to a ProducerTable, by name, EVENTPUBSUB.

The producer table uses a event-id and a sequence-id generated locally by event notifier as the key so that there wont be 
any conflicts across multiple applications trying to write to this table.

### 3.1.2 Event Consumer
The event consumer runs from sonic-eventd container. 

Event consumer subscribes to the EVENTPUBSUB table and gets notified whenever there is a new record.
On bootup, event consumer reads from this table.
Event consumer reads a record from this table and deletes records. 
So this table contains records that are published by application and waiting to be received by event consumer.

On reading the field value tuple, using the event-id in the record, event consumer fetches static information from static_event_table.
As mentioned above, static information contains severity, static message part and event enable/disable flag. 
If the flag is set to disabled, event consumer ignores the event by logging a debug message.
If the flag is set to enabled, it continues to process the event as follows:
- Determine if enable flag is enabled/disabled from static information table
- Generate new sequence-id for the event if enable flag is set to enabled
- Write the event to Event History Table
- It verifies if the event is stateful. If so, it forwards the event to alarm consumer for further processing.
    - If state is raised, add to ALARM table
    - If state is clear, remove the entry from ALARM table
    - Update LED 
- Forward the event to log handler

#### 3.1.2.1 Severity
Supported event severities: Critical, Warning, Informational
The corresponding syslog severties that will be used in log messages are: LOG_ALERT, LOG_WARNING, LOG_NOTICE respectively.
Through severity profiles, operator is allowed to use Major and Minor as well for backward compatibility with corresponding syslog severities LOG_CRIT and LOG_ERR respectively.

#### 3.1.2.2 Sequence-ID
Every new alert should have a sequential ID. The sequence-id is persistent and continues to grow until 2 exp 64 
before wrapping around to start from 1.

### 3.1.3 Alarm Consumer
The alarm consumer on receiving the event record, verifies the event state. If it is RAISE_ALARM, it adds the record to Current Alarm Table.
If the state is CLEAR_ALARM, it removes the previous record using the key ( source and event-id ). 
It then updates the system LED. 
The system LED update follows the following rule:
```
    Red if any outstanding Major or Critical alarms, else Yellow if any Minor or Warning alarms, else Green.
```

An outstanding alarm is an alarm that is either not cleared or not acknowledged by the user yet.

There will be a provision to acknowledge an alarm through CLI/REST/gNMI. On acknowledging, the system LED updates takes out acknowledged 
alarm into consideration.

### 3.1.4 Event Receivers
Supported NBIs are: syslog, REST and gNMI.

#### 3.1.4.1 syslog
Log handler should contain logic to take the event record, augment it with vendor specific information, format the message and 
send it to the destination.

A default log handler is used to format the incoming event notification to send it to syslog.

An example of syslog message generated by default log handler for an event raised by tam when changing switch-id
```
Feb 09 21:44:07.487906 2021 sonic NOTICE eventd#eventd[21]: Node.1-Unit.1:PRI [EVENT], %TAM_SWITCH_ID_CHANGE: :- processSwitchTblEvent: Received new switch-id as 2: switch-id changed.
```

Syslog message for an alarm raised by a sensor:
```
Feb 10 16:24:42.148610 2021 sonic NOTICE eventd#eventd[125]: Node.1-Unit.1:PRI [ALARM], %TEMPERATURE_EXCEEDED: :- temperatureCrossedThreshold: Current temperature of sensor/2 is 76 degrees: Temperature threshold is 75 degrees.
```
Various vendors can add their log handlers to overwrite the default log hander.

The syslog log handler should augment incoming native event record with dynamic information, vendor specific information to format 
message string and invoke syslog() as below:

Default log format is as below:
```
string node_info = "Node.1-Unit.1:PRI";
const char LOG_FORMAT[] = "%s [%s], %%%s: %s: %s"; // Node info
                                                   // Log Type
                                                   // Event Name
                                                   // Dynamic message
                                                   // Static message
   // raise a syslog message                                                
   syslog(LOG_MAKEPRI(ev_sev, SYSLOG_FACILITY), LOG_FORMAT,
        node_info.c_str(), ev_type.c_str(),
        ev_id.c_str(), ev_msg.c_str(), ev_static_msg.c_str());
        
```                                                      

An example custom log handler by a vendor could be as follows:
```
string node_info = "Node.1-Unit.1:PRI";
constexpr char LOG_FORMAT[]     = "%s [%s - %s], %s %%%s: %s: %s {%s %s %s}";    
                                   // Node info
                                   // Log Type
                                   // Log severity
                                   // Vendor Name
                                   // Event Name
                                   // Dynamic message
                                   // Static message
                                   // vendor specific-id
                                   // vendor specific-desc
                                   // vendor specific-category

    // raise a syslog message
    syslog(LOG_MAKEPRI(SYSLOG_SEVERITY[ev_sev], SYSLOG_FACILITY),LOG_FORMAT,
        LOG_NODE_INFO, ev_type.c_str(), SYSLOG_SEVERITY_STR[ev_sev].c_str(),
        vender_info.c_str(), ev_id.c_str(), ev_msg.c_str(), ev_static_msg.c_str(), 
        vendor_id.c_str(), vendor_desc.c_str(), vendor_category.c_str());
```
Operator can configure specifc syslog host to receive either syslog messages corresponding to events or general log messages.
Through CLI, operator can chose 'logging server <ip> [log|event]' command.
When operator configures a host with 'event' type, it receives *only* log messages corresponding to events.
Support for VRF/source-interface/UDP port are all are applicable for 'event' type.

#### 3.1.4.2 REST
Traslib does not support streamed RPC responses for framework to send messages over REST.
This is being planned for Phase-2 when infra is ready to support it.

#### 3.1.4.3 gNMI
gNMI clients can subscribe to receive event notifications. Subscribed gNMI clients receive native event fields and 
there is no customization of these fileds similar to syslog messages.

TODO: add definitions of protobuf spec

#### 3.1.4.5 System LED
The original requirement was to change LED based on severities of the events. But on most of the platforms the system/power/fan LEDs are managed by the BMC. 
BMC (baseboard management controller) is an embedded system that manages various platform elements like fan, PSU, temperature sensors. 
There is an API that can be invoked to control LED, but not all platforms will support that API if they are fully controlled by the BMC.
So, on certain platforms, system LED could not represent events on the system.

Another issue is: Currently pmon controls LED, and as eventd now tries to change the very same LED, this leads to conflicts. 
A mechanism must exist for one of these to be master.
The proposed solution could be to have a system health paramter in the DB. 
This is updated by eventd and pmon could use it to update LED accordingly. 

#### 3.1.4.6 Event/Alarm flooding
There are scenarios when system enters a loop of a fault condition that makes application trigger events continuously. To avoid such
instances flood the EVENT or ALARM tables, eventd maintains a cache of last event/alarm. Every new event/alarm is compared against this cache entry
to make sure it is not a flood. If it is found to be same event/alarm, the newly raised entry will be silently discarded.

### 3.1.5 Severity Profile
The Severity profile contains mapping between event-id and severity of the event, enable/disable flag.
Through severity profile, operator can change severity of a particular event. And can also enable/disable
a particular event.

On bootup, event framework would create default event profile based on static_event_table. 
By default, every event is enabled.
The severity of event is decided by designer while adding the event.

The default severity profile is stored at /etc/sonic/severity-profile/default.json

User can upload the default severity profile to a remote host. User can modify characteristics of
certain events in the profile and can download it back to the switch.

The updated profile will become custom severity profile.

User can select any of the custom severity profiles under /etc/sonic/severity-profile/ using 'severity-profile' command.

The framework will sanity check the user selected severity profile and merges it with static_event_table.

The selected severity profile will be "active" after a reboot.

To "remember" the selected custom profile across reboots, an internal symlink points to the selected custom
profile.

The event consumer will use the static_event_table map to decide whether to raise an event or not. If event
is to be raised, static_event_table is again looked into for severity.

Upgrade hooks will be used to persist custom severity profiles.


### 3.1.6 CLI
The show CLI require many filters with range specifiers.
This is supported with the help of new operation using RPC.
That is, the event list can be a target resource for normal Get, while CLI can use the customized/RPC Get with a range option.

e.g.
```
rpc getEventBySeqeuenceId{
input {
    from sequence-id;
    to sequence-id;
  }
output {
   list event-table-entries; 
}
```

The rpc callback needs to access DB with the given set of sequence ids.

The gNMI server need to be extended to support the RPC to support similar operations for gNMI.

### 3.1.7 Event History Table and Current Alarm Table
The Event History Table and Current Alarm List Table stored in state db. 
The size of Event History Table is 86k records or 30 days worth of events which ever hits earlier.
The manifest file will be updated with parameters to specify the number and number of days limits for
eventd to read and enforce them.

When either of the limit is reached, the framework wraps around the table records by discarding the older records.

An example of an event in EVENT table raised by tam.
```
Event Table:
==============================

Key                       : id

id                        : Unique sequential ID generated by the system for every event {uint64}
type-id                   : Name of the event generated {string}
text                      : Dynamic message describing the cause for the event {string}
time-created              : Time stamp at which the event is generated {uint64}
is-alarm                  : Indicates if the record is stateful event {boolean}
resource                  : Object which generated the event {string}

127.0.0.1:6379[6]> hgetall "EVENT|1"
 1) "id"
 2) "1"
 3) "type-id"
 4) "TAM_SWITCH_ID_CHANGE"
 5) "text"
 6) "processSwitchTblEvent: Received new switch-id as 3"
 7) "time-created"
 8) "2021-02-09.21:42:59.553603"
 9) "is-alarm"
10) "false"
11) "resource"
12) "3"
127.0.0.1:6379[6]>
```
Current Alarm Table will not have any limits as it only contains the snapshot of the alarms during the current run.

Contents of an alarm record. In this case, the alarm was raised temperature crossed a threshold.
```
Current Alarm Table:
==============================

Key                       : id

id                        : Unique sequential ID generated by the system for every event {uint64}
type-id                   : Name of the event generated {string}
text                      : Dynamic message describing the cause for the event {string}
time-created              : Time stamp at which the event is generated {uint64}
is-acknowledged           : Indicates if alarm has been acknowledged {boolean}
resource                  : Object which generated the event {string}

127.0.0.1:6379[6]> hgetall "ALARM|29"
 1) "id"
 2) "29"
 3) "type-id"
 4) "TEMPERATURE_EXCEEDED"
 5) "text"
 6) "temperatureCrossedThreshold: Current temperature for sensor/2 is 76 degrees"
 7) "resource"
 8) "sensor/2"
 9) "time-created"
10) "2021-02-10.04:51:53.454450"
11) "is-acknowledged"
12) "false"
127.0.0.1:6379[6]>
```

### 3.1.8 Pull Model
All NBIs - CLI, REST and gNMI - can pull contents of alarm history table and event history table based on openconfig yang model.
The following filters are supported:
- ALL ( pulls all alarms)
- Severity.
- Recent alarms (eg., last 5 minutes, one hour, one day).
- Records between two timestamps, one timestamp and end, and   beginning and a timestamp.
- All records between two Sequence Numbers (incl end and begin)

### 3.1.9 Supporting third party containers
To support third party components ( e.g. FRR, teamd, DHCP Relay, LLDPd, ntpd etc ) which can not be modified to raise events, the following options are considered 
and are being evaluated.
1.  Patch the components
    Create a patch for these components by adding libeventnotify library and invoke the API. This however, requires these patches need to be maintained in the code forever.

2.  Listen to syslog messages
    As many of these components raises syslog messages on an important event, a listener can be implemented to read incoming syslog messages and raise 
    events based on the message.
    This however is heavy on performance due to the fact that listener has to parse each syslog message. Also listener need to maintain a map of messages to 
    event-id and need to be aware of resource and other specific details. It need to be aware of nuances of alarm raising/clearing if the component follows
    any specific logic. 

## 3.2 DB Changes
### 3.2.1 CONFIG DB
### 3.2.2 APP DB
### 3.2.3 STATE DB
Two new tables are introduced. 
Event History Table (EVENT) and Current Alarm Table (ALARM).

A pubsub table is used: EVENTPUBSUB between applications and eventconsumer.
### 3.2.4 ASIC DB
### 3.2.5 COUNTER DB

## 3.3 User Interface
### 3.3.1 Data Models

The following is yang for events.
```
module: sonic-event
  +--rw sonic-event
     +--rw EVENT
     |  +--rw EVENT_LIST* [id]
     |     +--rw id              uint64
     |     +--rw resource?       string
     |     +--rw text?           string
     |     +--rw time-created?   uint64
     |     +--rw type-id?        string
     |     +--rw severity?       enumeration
     |     +--rw is-alarm?       boolean
     +--rw EVENT_STATS
        +--rw EVENT_STATS_LIST* [id]
           +--rw id            enumeration
           +--rw events?       uint32
           +--rw alarms?       uint32
           +--rw acked?        uint32
           +--rw cleared?      uint32
           +--rw non-alarms?   uint32

  rpcs:
    +---x show-events
       +---w input
       |  +---w (option)?
       |     +--:(time)
       |     |  +---w time
       |     |     +---w begin?   yang:date-and-time
       |     |     +---w end?     yang:date-and-time
       |     +--:(last-interval)
       |     |  +---w period?   uint32
       |     +--:(identifier)
       |        +---w id
       |           +---w begin?   uint64
       |           +---w end?     uint64
       +--ro output
          +--ro EVENT_LIST* [id]
             +--ro id              uint64
             +--ro resource?       string
             +--ro text?           string
             +--ro time-created?   uint64
             +--ro type-id?        string
             +--ro severity?       enumeration
             +--ro is-alarm?       boolean
```

The following is yang for alarms.
```
module: sonic-alarm
  +--rw sonic-alarm
     +--rw ALARM
     |  +--rw ALARM_LIST* [id]
     |     +--rw id                 uint64
     |     +--rw resource?          string
     |     +--rw text?              string
     |     +--rw time-created?      uint64
     |     +--rw type-id?           string
     |     +--rw severity?          enumeration
     |     +--rw is-acknowledged?   boolean
     +--rw ALARM_STATS
        +--rw ALARM_STATS_LIST* [id]
           +--rw id               enumeration
           +--rw alarms?          uint32
           +--rw critical?        uint32
           +--rw major?           uint32
           +--rw minor?           uint32
           +--rw warning?         uint32
           +--rw informational?   uint32
           +--rw acknowledged?    uint32

  rpcs:
    +---x ack-alarms
    |  +---w input
    |  |  +---w id*   uint64
    |  +--ro output
    |     +--ro status?   string
    +---x show-alarms
       +---w input
       |  +---w (option)?
       |     +--:(time)
       |     |  +---w time
       |     |     +---w begin?   yang:date-and-time
       |     |     +---w end?     yang:date-and-time
       |     +--:(last-interval)
       |     |  +---w period?   uint32
       |     +--:(identifier)
       |        +---w id
       |           +---w begin?   uint64
       |           +---w end?     uint64
       +--ro output
          +--ro ALARM_LIST* [id]
             +--ro id                 uint64
             +--ro resource?          string
             +--ro text?              string
             +--ro time-created?      uint64
             +--ro type-id?           string
             +--ro severity?          enumeration
             +--ro is-acknowledged?   boolean
```

### 3.3.2 CLI
#### 3.3.2.1 Exec Commands
```
sonic# alarm acknowledge <seq-id-of-raised-alarm>
```
An operator can acknolwedge a raised alarm. This indicates that the operator is aware of the fault condition and considers the condition not catastrophic. 
Acknowledging an alarm updates system LED by removing the alarm from status considration.

The alarm record in the ALARM table is marked with is_acknowledged field set to true.

#### 3.3.2.2 Configuration Commands
```
sonic(config)# event severity-profile <profile-name>
sonic(config)# logging server <ip> [log|event] 
```
Note: The 'logging server' command is an existing, already supported command. 
It is only enhanced to take either 'log' or 'event' to indicate either native syslog messages or syslog messages corresponding to events alone are sent to the remote host.
Support with VRF/source-interface and configuring remote-port are all backward comaptible and will be applicable to either 'log' or 'event' options.

#### 3.3.2.3 Show Commands
```
sonic# show event severity-profile

Severity Profile Details
----------------------------------------
Currently active     :  default
Active after restart :  mysev_prof

sonic# show event [ detail | summary | severity <sev> | timestamp from <from-ts> to <to-ts> | recent <5min|1hr|1day> | sequence-id from <from-seq> to <to-seq> ] 

'show event' commands would display all the records in EVENT table.

sonic# show event 
Sq No   State        Name                             Timestamp                   Description
-----   --------     ------------------------------   --------------------------- --------------
2292    stateless    TAM_SWITCH_ID_CHANGE             Wed Feb 10 18:08:27 2021    processSwitchTblEvent: Received new switch-id as 3        
2291    stateful     TEMPERATURE_EXCEEDED             Wed Feb 10 18:08:24 2021    temperatureCrossedThreshold: Current temperature of sensor/2 is 76 degrees
        
      
sonic# show event details 
Event History Details - 2292
-------------------------------------------
Sequence Number:   2292
Severity:          informational
Name:              TAM_SWITCH_ID_CHANGE
Description:       processSwitchTblEvent: Received new switch-id as 3
Timestamp:         Wed Feb 10 18:08:27 2021
Source:            -
State:             stateless
-------------------------------------------
Event History Details - 2291
-------------------------------------------
Sequence Number:   2291
Severity:          critical
Name:              TEMPERATURE_EXCEEDED
Description:       temperatureCrossedThreshold: Current temperature of sensor/2 is 76 degrees
Timestamp:         Wed Feb 10 18:08:24 2021
Source:            -
State:             stateful

sonic# show event summary

Event Summary
-------------------------------------------
Raised:                 1
Ack:                    0
Cleared:                4
Events:                 1
-------------------------------------------

sonic# show event severity critical
Sq No   State        Name                             Timestamp                   Description
-----   --------     ------------------------------   --------------------------- --------------
2291    stateful     TEMPERATURE_EXCEEDED             Wed Feb 10 17:58:19 2021    temperatureCrossedThreshold: Current temperature of sensor/2 is 76 degrees. 

sonic# show event recent 5min 
Sq No   State        Name                             Timestamp                   Source
-----   --------     ------------------------------   --------------------------- --------------
2292    stateless    TAM_SWITCH_ID_CHANGE             Wed Feb 10 18:08:27 2021    processSwitchTblEvent: Received new switch-id as 3        
2291    stateful     TEMPERATURE_EXCEEDED             Wed Feb 10 18:08:24 2021    temperatureCrossedThreshold: Current temperature of sensor/2 is 76 degrees

sonic# show event sequence-id from 2290 to 2300
Sq No   State        Name                             Timestamp                   Source
-----   --------     ------------------------------   --------------------------- --------------
2292    stateless    TAM_SWITCH_ID_CHANGE             Wed Feb 10 18:08:27 2021    processSwitchTblEvent: Received new switch-id as 3        
2291    stateful     TEMPERATURE_EXCEEDED             Wed Feb 10 18:08:24 2021    temperatureCrossedThreshold: Current temperature of sensor/2 is 76 degrees


sonic# show alarm [ detail | summary | severity <sev> | timestamp from <from-ts> to <to-ts> | recent <5min|1hr|1day> | sequence-id from <from-seq> to <to-seq> | all ]

'show alarm' command would display all the active alarm records in ALARM table.

sonic# show alarm
  
Sq No     Severity         Name                             Timestamp                   Source
------    -------------    ------------------------------   --------------------------- --------------
2291      critical         TEMPERATURE_EXCEEDED             Wed Feb 10 18:08:24 2021    /sensor/2  

sonic# show alarm detail 
  
Active-alarm details - 2291
-------------------------------------------
Sequence Number:   2291
Severity:          critical
Source:            /sensor/2
Name:              TEMPERATURE_EXCEEDED
Description:       temperatureCrossedThreshold: Current temperature of sensor/2 is 76 degrees
Raise-time:        Wed Feb 10 18:08:24 2021
Ack-time:          
New:               true
Acknowledged:      false

sonic# show alarm summary
Active-alarm Summary
-------------------------------------------
Total:            2
Critical:         2
Major:            1
Minor:            1
Warning:          0
Acknowledged:     1
Informational:    0
-------------------------------------------
Major/Minor will be displayed only if there is a non-zero value exists for these counters.

sonic# show alarm severity critical
Sq No  Name                             Timestamp                   Description
-----  ------------------------------   --------------------------- --------------
2291   TEMPERATURE_EXCEEDED             Wed Feb 10 17:58:19 2021    temperatureCrossedThreshold: Current temperature of sensor/2 is 76 degrees. 

sonic# show alarm recent 5min 
Sq No  Name                             Timestamp                   Source
-----  ------------------------------   --------------------------- --------------
2291   TEMPERATURE_EXCEEDED             Wed Feb 10 18:08:24 2021    temperatureCrossedThreshold: Current temperature of sensor/2 is 76 degrees

sonic# show alarm sequence-id from 2290 to 2300
Sq No  Name                             Timestamp                   Source
-----  ------------------------------   --------------------------- --------------
2291   TEMPERATURE_EXCEEDED             Wed Feb 10 18:08:24 2021    temperatureCrossedThreshold: Current temperature of sensor/2 is 76 degrees

sonic# show alarm all
  
Sq No  Severity         Name                             Timestamp                   Source          Acknowledged
------ -------------    ------------------------------   --------------------------- --------------  ---------------
2291   critical         TEMPERATURE_EXCEEDED             Wed Feb 10 18:08:24 2021    /sensor/2       false
178    critical         PSU_FAULT                        Wed Dec 30 21:59:07 2020    /psu/2          true

```

### 3.3.3 REST API Support
/restconf/data/sonic-event:sonic-event/EHL_TABLE/EHL_TABLE_LIST

# 4 Flow Diagrams
![Sequence Diagram](event-mgmt-framework-sequence-diagram.png)

# 5 Warm Boot Support
## 5.1 Application warm boot
Applications confirming to the warm boot, should have stored their state and compare current values against previous values.
Such complaint application also "remembers" that it raised an event before for a specific condition.
They would 
*  not raise alarms/events for the same condition that it raised pre warm boot
*  clear those alarms once current state of a particular condition is recovered (by comparing against the stored state). 

## 5.2 eventd warm boot
Records from applications are stored in a table of type ProducerTable.
By using ProducerTable, records that are being written will be queued when the subscriber (eventd) is down.

This is in contrast to notification producer/consumer tables which causes incoming records getting lost.

The eventnotify from each application would write events to ProducerTable that eventd subscribes to. 
eventnotify uses event-id and a local sequence-id as the key while writing records to this table.

During normal operation, eventd receives subscription notifications whenever a new record is added to the table.
eventd reads and removes records.

When eventd is restarted, events and alarms raised by applications will be waiting in a queue while eventd is coming up.
When eventd eventually comes back up, it reads those records in the queue.

# 6 Scalability
The size of Event History Table is 86k records or 30 days worth of events which ever hits earlier with a frequency of one event per second.

# 7 Unit Test
- Raise an event and verify the fields in EVENT table and EVENT_STATS table
- Raise an alarm and verify the fields in ALARM table and ALARM_STATS table
- Clear an alarm and verify that record is removed from ALARM and ALARM_STATS tables are udpated
- Ack an alarm and verify that is_acknowledged flag is set to true in ALARM table
- Verify wrap around for EVENT table ( change manifest file to a lower range and trigger that many events )
- Verify sequence-id for events is persistent by restarting
- Verify counters by raising various alarms with different severities 
- Change severity of an event through custom severity profile and verify it is logged at specified severity
- Change enable/disable of an event through custom severity profile and verify it is suppressed
- Verify custom severity profile with an invalid event-id is rejected 
- Verify custom severity profile with an invalid severity is rejected 
- Verify custom severity profile with an invalid enable/disable flag is rejected 
- Verify custom severity profile with an invalid json syntax is rejected 
- Verify custom severity profile is persisted after a reboot
- Verify various show commands
- Verify 'logging-server <ip> event' command forwards only event log messages to the host
